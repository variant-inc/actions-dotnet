---
name: Test Dotnet
description: |
  Github Action to Build & Test Dotnet

  RequiredEnv:
    GITHUB_TOKEN
    SONAR_TOKEN
inputs:
  dotnet-version:
    description: >
      The dotnet-version input is optional.
      The default version of Dotnet in PATH varies
      between runners and can be changed unexpectedly
      so we recommend always setting Dotnet version explicitly
      using the dotnet-version input.
    required: false
runs:
  using: composite
  steps:
    - name: Set up Dotnet
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ inputs.dotnet-version }}

    - name: Cache NuGet Packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ github.repository }}-nuget

    - name: Set up Dotnet
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 5.0.x

    - name: Run pre_test.sh
      shell: bash
      run: |
        pretest_cmd="echo 'NO_PRETEST'"
        if [ -f ".github/actions/pre_test.sh" ]; then
            pretest_cmd="$(cat .github/actions/pre_test.sh)"
        fi
        echo "pretest_cmd: $pretest_cmd"
        sh -c "${pretest_cmd}"

    - uses: actions/setup-java@v5
      if: env.ENABLE_SONAR == 'true'
      with:
        distribution: zulu
        java-version: '17'

    - name: Restore Application Dependencies
      shell: bash
      run: |
        echo "::group::Upgrade Packages"
        dotnet restore
        echo "::endgroup::"

    # Speed-up analysis by caching the scanner workspace
    - name: Cache SonarCloud workspace
      uses: actions/cache@v4
      if: env.ENABLE_SONAR == 'true'
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar-cache
        restore-keys: ${{ runner.os }}-sonar-cache

    # Speed-up analysis by caching the scanner installation
    - name: Cache Dotnet Tools
      id: cache-sonar-scanner
      uses: actions/cache@v4
      if: env.ENABLE_SONAR == 'true'
      with:
        path: ./.tools
        key: ${{ runner.os }}-sonar-scanner
        restore-keys: ${{ runner.os }}-sonar-scanner

    - name: Install Sonarscan Dependencies
      if: steps.cache-sonar-scanner.outputs.cache-hit != 'true'
      shell: bash
      run: |
        mkdir -p ./.tools

        if [[ "$ENABLE_SONAR" == "true" ]]; then
          dotnet tool update dotnet-sonarscanner --tool-path ./.tools
        fi
        dotnet tool update coverlet.console --tool-path ./.tools

    - name: Check Dockerfile existence
      id: check_dockerfile
      uses: andstor/file-existence-action@v3
      if: env.ENABLE_SONAR == 'true'
      with:
        files: Dockerfile

    - uses: hadolint/hadolint-action@v3.3.0
      if: >
        steps.check_dockerfile.outputs.files_exists == 'true' &&
        env.ENABLE_SONAR == 'true'
      with:
        dockerfile: Dockerfile
        output-file: coverage/hadolint.sonar
        format: sonarqube
        no-fail: true

    - name: dotnet test & sonarscan
      shell: bash
      run: |
        export PATH=$PATH:$GITHUB_WORKSPACE/.tools
        ./.github/workflows/actions-dotnet/test/test.sh

    - name: Generate Pretty Report (only if tests pass)
      if: env.ENABLE_SONAR != 'true'
      uses: danielpalme/ReportGenerator-GitHub-Action@5.4.16
      with:
        reports: '**/coverage.opencover.xml'
        targetdir: coveragereport
        reporttypes: Html;MarkdownSummaryGithub
        title: ðŸ“Š Test Results

    - name: Add to Build Summary
      if: env.ENABLE_SONAR != 'true'
      run: cat coveragereport/SummaryGithub.md >> $GITHUB_STEP_SUMMARY
      shell: bash

    - name: Upload Coverage Report
      if: env.ENABLE_SONAR != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coveragereport
